<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="styles.css">
    <title>PMDB: Create-Song</title>

    <script>
        //Auto fill text fields using the info from the url query after page contents has been loaded
        window.onload = function () {
            //Collect url query info to use for autofill
            const urlString = window.location.search;
            const urlParams = new URLSearchParams(urlString);
            const rawValue = urlParams.get('data');
            const myArray = JSON.parse(decodeURIComponent(rawValue));
            console.log(myArray);

            //If the array has data from the url query, auto fill the text fields
            if (myArray != null) {
                const titleInput = document.getElementById('title');
                const artistInput = document.getElementById('artist');
                const albumInput = document.getElementById('album');

                titleInput.value = myArray[0];
                artistInput.value = myArray[1];
                albumInput.value = myArray[2];
            }

            const delButton = document.getElementById("deleteButton");

            delButton.addEventListener("click", function () {
                const xhttp = new XMLHttpRequest();
                xhttp.open("DELETE", "http://localhost:5000/deleteSong?song_name=" + url, true);
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById("feedback").innerHTML = this.responseText;
                    }
                };
            })
        }

        function makePostRequest() {
            event.preventDefault();

            //Create element containing data from form. Convert data into JSON string.
            const formContainer = document.getElementById('songForm');
            const formElem = new FormData(formContainer);
            const data = Object.fromEntries(formElem.entries());
            const jsonString = JSON.stringify(data);
            console.log(jsonString);

            //Create POST request, sends server JSON string
            const xhttp = new XMLHttpRequest();
            //NEED TO ADD SUBMIT URL
            xhttp.open("POST", "url-update-place-holder", true);
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("feedback").innerHTML = this.responseText;
                }
            };
            xhttp.send(jsonString);
        }
    </script>
</head>

<body>

    <!-- Top nav bar -->
    <h1>Personalized Music Database: Create</h1>

    <div id="topnav">
        <a href="main.html">Home</a>
        <a href="create.html">Create</a>
        <a href="update.html">Update</a>
    </div>

    <hr />

    <!-- Form to update data -->
    <form id="songForm" onsubmit="makePostRequest(); return false;">
        <label for="title">Title: </label>
        <input type="text" id="title" name="title" value="">
        <br /><br />
        <label for="artist">Artist: </label>
        <input type="text" id="artist" name="artist" value="">
        <br /><br />
        <label for="album">Album: </label>
        <input type="text" id="album" name="album" value="">
        <br /><br />
        <label for="playlist">Playlist: </label>
        <input type="text" id="playlist" name="playlist" value="">
        <br /><br /><br />
        <input type="submit" value="Submit">
        <input type="button" id="deleteButton" value="Delete">
    </form>

    <!-- Feedback from server if any -->
    <p id="feedback"></p>

</body>

</html>